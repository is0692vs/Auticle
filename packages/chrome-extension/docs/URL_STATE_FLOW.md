# URL State Feature Flow Diagram

## データフロー

```
┌─────────────────────────────────────────────────────────────────┐
│                     User Opens Popup                            │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  popup.js: chrome.tabs.query() で現在のタブのURLを取得          │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  getHostnameFromUrl(url) でホスト名を抽出                       │
│  例: "https://example.com/page" → "example.com"                 │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  chrome.storage.local.get(["urlStates", "enabled"])             │
│  ストレージから状態を読み込む                                   │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  hostname in urlStates ?                                        │
│    YES: urlStates[hostname] を使用                              │
│    NO:  enabled (グローバル) をフォールバックとして使用         │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  toggleSwitch.checked = isEnabled                               │
│  スイッチの状態を更新                                           │
└─────────────────────────────────────────────────────────────────┘
```

## 状態保存フロー

```
┌─────────────────────────────────────────────────────────────────┐
│           User Toggles Switch in Popup                          │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  popup.js: toggleSwitch.addEventListener("change")              │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  chrome.storage.local.get(["urlStates"])                        │
│  既存のurlStatesを取得                                          │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  urlStates[hostname] = isEnabled                                │
│  現在のホスト名の状態を更新                                     │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  chrome.storage.local.set({ urlStates })                        │
│  更新された状態を保存                                           │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  chrome.storage.onChanged イベント発火                          │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  content.js: ストレージ変更を検知                               │
│  loadCurrentUrlState() で現在のURL状態を再取得                  │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  updatePageState(isEnabled)                                     │
│  ページのON/OFF状態を更新 (preparePage/cleanupPage)             │
└─────────────────────────────────────────────────────────────────┘
```

## ストレージ構造の変化

### Before (従来)
```javascript
{
  "enabled": true  // 全ページ共通のON/OFF状態
}
```

### After (新機能)
```javascript
{
  "enabled": false,  // グローバルのデフォルト値（後方互換性のため保持）
  "urlStates": {
    "example.com": true,
    "github.com": false,
    "qiita.com": true
    // ... 各ホスト名ごとの状態
  }
}
```

## ページ読み込み時のフロー (content.js)

```
┌─────────────────────────────────────────────────────────────────┐
│                    Page Loads                                   │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  content.js: loadCurrentUrlState() 実行                          │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  getCurrentHostname() で現在のホスト名を取得                    │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  chrome.storage.local.get(["urlStates", "enabled"])             │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  URL固有の状態を判定                                            │
│  hostname in urlStates ? urlStates[hostname] : enabled          │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│  callback(isEnabled) でページ状態を更新                         │
│  → updatePageState(isEnabled)                                   │
└─────────────────────────────────────────────────────────────────┘
```

## 使用例シナリオ

### シナリオ 1: 新しいサイトでの初回訪問

1. ユーザーが `https://newsite.com` を訪問
2. content.js が `loadCurrentUrlState()` を実行
3. `urlStates` に `newsite.com` のエントリがない
4. フォールバック: グローバルの `enabled` 値を使用（デフォルトはfalse）
5. ページは読み上げモードOFF状態で表示

### シナリオ 2: 既に設定済みのサイトでの訪問

1. ユーザーが `https://example.com` を訪問（以前ONに設定済み）
2. content.js が `loadCurrentUrlState()` を実行
3. `urlStates["example.com"]` が `true` として存在
4. ページは読み上げモードON状態で表示
5. 段落がクリック可能になる

### シナリオ 3: サイト間の移動

```
example.com (ON) → github.com (未設定) → qiita.com (OFF) → example.com (ON)
     ↓                   ↓                    ↓                   ↓
   準備完了           デフォルト状態         クリーンアップ       準備完了
```

各サイトで独立した状態が保持され、ページ移動時も設定が維持される。
